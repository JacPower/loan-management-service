


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LoanService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.interview.lender.services</a>
</div>

<h1>Coverage Summary for Class: LoanService (com.interview.lender.services)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LoanService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (11/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.3%
  </span>
  <span class="absValue">
    (17/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    99.2%
  </span>
  <span class="absValue">
    (122/123)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LoanService$MockitoMock$44wKPysh</td>
  </tr>
  <tr>
    <td class="name">LoanService$MockitoMock$44wKPysh$auxiliary$109eEg6p</td>
  </tr>
  <tr>
    <td class="name">LoanService$MockitoMock$44wKPysh$auxiliary$6OZx9Jnb</td>
  </tr>
  <tr>
    <td class="name">LoanService$MockitoMock$44wKPysh$auxiliary$7SRXickl</td>
  </tr>
  <tr>
    <td class="name">LoanService$MockitoMock$44wKPysh$auxiliary$autLPQbT</td>
  </tr>
  <tr>
    <td class="name">LoanService$MockitoMock$44wKPysh$auxiliary$dRYi7nRF</td>
  </tr>
  <tr>
    <td class="name">LoanService$MockitoMock$44wKPysh$auxiliary$KoFFVw48</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (11/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.3%
  </span>
  <span class="absValue">
    (17/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    99.2%
  </span>
  <span class="absValue">
    (122/123)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.interview.lender.services;
&nbsp;
&nbsp;import com.interview.lender.config.AppConfig;
&nbsp;import com.interview.lender.dto.*;
&nbsp;import com.interview.lender.entity.Customer;
&nbsp;import com.interview.lender.entity.Loan;
&nbsp;import com.interview.lender.enums.LoanStatus;
&nbsp;import com.interview.lender.repository.CustomerRepository;
&nbsp;import com.interview.lender.repository.LoanRepository;
&nbsp;import com.interview.lender.util.Util;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.List;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;import static org.springframework.http.HttpStatus.*;
&nbsp;
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Transactional
&nbsp;public class LoanService {
&nbsp;
&nbsp;    private final LoanRepository loanRepository;
&nbsp;    private final CustomerRepository customerRepository;
&nbsp;    private final CustomerService customerService;
&nbsp;    private final ScoringService scoringService;
&nbsp;    private final AppConfig appConfig;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    public ResponseDto subscribeCustomer(SubscriptionRequest request) {
<b class="fc">&nbsp;        log.info(&quot;Processing subscription request for customer: {}&quot;, request.getCustomerNumber());</b>
&nbsp;
<b class="fc">&nbsp;        if (customerRepository.existsByCustomerNumber(request.getCustomerNumber())) {</b>
<b class="fc">&nbsp;            log.error(&quot;Customer subscription already exist | CustomerNumber: {}&quot;, request.getCustomerNumber());</b>
<b class="fc">&nbsp;            return Util.buildErrorResponse(&quot;Customer subscription already exist&quot;, CONFLICT);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Optional&lt;CustomerDto&gt; optionalCustomerDto = customerService.getCustomerByNumber(request.getCustomerNumber());</b>
<b class="fc">&nbsp;        if (optionalCustomerDto.isEmpty()) {</b>
<b class="fc">&nbsp;            log.error(&quot;Customer not found | CustomerNumber: {}&quot;, request.getCustomerNumber());</b>
<b class="fc">&nbsp;            return Util.buildErrorResponse(&quot;Customer does not exist&quot;, NOT_FOUND);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        CustomerDto customerDto = optionalCustomerDto.get();</b>
<b class="fc">&nbsp;        saveCustomer(customerDto);</b>
<b class="fc">&nbsp;        log.info(&quot;Customer saved to local database | CustomerNumber: {}&quot;, customerDto.getCustomerNumber());</b>
<b class="fc">&nbsp;        var response = SubscriptionResponse.builder()</b>
<b class="fc">&nbsp;                .customerNumber(customerDto.getCustomerNumber())</b>
<b class="fc">&nbsp;                .customerName(customerDto.getFirstName() + &quot; &quot; + customerDto.getLastName())</b>
<b class="fc">&nbsp;                .phoneNumber(customerDto.getMobile())</b>
<b class="fc">&nbsp;                .email(customerDto.getEmail())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;
<b class="fc">&nbsp;        return Util.buildSuccessResponse(&quot;Subscription successful&quot;, response, OK);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    private void saveCustomer(CustomerDto dto) {
<b class="fc">&nbsp;        Customer customer = Customer.builder()</b>
<b class="fc">&nbsp;                .customerNumber(dto.getCustomerNumber())</b>
<b class="fc">&nbsp;                .firstName(dto.getFirstName())</b>
<b class="fc">&nbsp;                .middleName(dto.getMiddleName())</b>
<b class="fc">&nbsp;                .lastName(dto.getLastName())</b>
<b class="fc">&nbsp;                .phoneNumber(dto.getMobile())</b>
<b class="fc">&nbsp;                .email(dto.getEmail())</b>
<b class="fc">&nbsp;                .gender(dto.getGender())</b>
<b class="fc">&nbsp;                .idNumber(dto.getIdNumber())</b>
<b class="fc">&nbsp;                .idNumberType(dto.getIdType())</b>
<b class="fc">&nbsp;                .monthlyIncome(dto.getMonthlyIncome())</b>
<b class="fc">&nbsp;                .isActive(&quot;ACTIVE&quot;.equalsIgnoreCase(dto.getStatus()))</b>
<b class="fc">&nbsp;                .registrationDate(dto.getCreatedAt())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;
<b class="fc">&nbsp;        customerRepository.save(customer);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;    public ResponseDto requestLoan(LoanRequest request) {
<b class="fc">&nbsp;        log.info(&quot;Processing loan request | CustomerNumber: {}, amount: {}&quot;, request.getCustomerNumber(), request.getAmount());</b>
&nbsp;
<b class="fc">&nbsp;        Optional&lt;Customer&gt; optionalCustomer = customerRepository.findByCustomerNumber(request.getCustomerNumber());</b>
<b class="fc">&nbsp;        if (optionalCustomer.isEmpty()) {</b>
<b class="fc">&nbsp;            log.error(&quot;Customer has an ongoing loan request | CustomerNumber: {}&quot;, request.getCustomerNumber());</b>
<b class="fc">&nbsp;            return Util.buildErrorResponse(&quot;There is an ongoing loan request.&quot;, BAD_REQUEST);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Customer customer = optionalCustomer.get();</b>
<b class="fc">&nbsp;        Loan loan = saveLoanRequest(request);</b>
&nbsp;
<b class="fc">&nbsp;        String scoringToken = scoringService.initiateScoring(request.getCustomerNumber());</b>
<b class="fc">&nbsp;        updateLoanStatus(loan);</b>
<b class="fc">&nbsp;        updateCustomerScoringToken(customer, scoringToken);</b>
&nbsp;
<b class="fc">&nbsp;        log.info(&quot;Loan application created | Loan ID: {}, scoring token: {}&quot;, loan.getId(), scoringToken);</b>
<b class="fc">&nbsp;        var response = LoanResponse.builder()</b>
<b class="fc">&nbsp;                .loanId(loan.getId())</b>
<b class="fc">&nbsp;                .customerNumber(loan.getCustomerNumber())</b>
<b class="fc">&nbsp;                .requestedAmount(loan.getRequestedAmount())</b>
<b class="fc">&nbsp;                .status(loan.getStatus().name())</b>
<b class="fc">&nbsp;                .applicationDate(loan.getApplicationDate())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;
<b class="fc">&nbsp;        return Util.buildSuccessResponse(&quot;Loan application submitted successfully&quot;, response, CREATED);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public ResponseDto getLoanStatus(String customerNumber) {
<b class="fc">&nbsp;        log.info(&quot;Getting loan status for customer: {}&quot;, customerNumber);</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Loan&gt; loans = loanRepository.findByCustomerNumber(customerNumber);</b>
<b class="fc">&nbsp;        if (loans.isEmpty()) {</b>
<b class="fc">&nbsp;            log.info(&quot;No loan found | CustomerNumber: {}&quot;, customerNumber);</b>
<b class="fc">&nbsp;            return Util.buildErrorResponse(&quot;No loan found.&quot;, NOT_FOUND);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Loan loan = loans.getLast();</b>
<b class="fc">&nbsp;        var response = LoanStatusResponse.builder()</b>
<b class="fc">&nbsp;                .loanId(loan.getId())</b>
<b class="fc">&nbsp;                .customerNumber(loan.getCustomerNumber())</b>
<b class="fc">&nbsp;                .requestedAmount(loan.getRequestedAmount())</b>
<b class="fc">&nbsp;                .approvedAmount(loan.getApprovedAmount())</b>
<b class="fc">&nbsp;                .status(loan.getStatus().name())</b>
<b class="fc">&nbsp;                .creditScore(loan.getCreditScore())</b>
<b class="fc">&nbsp;                .creditLimit(loan.getCreditLimit())</b>
<b class="fc">&nbsp;                .exclusion(loan.getExclusion())</b>
<b class="fc">&nbsp;                .exclusionReason(loan.getExclusionReason())</b>
<b class="fc">&nbsp;                .applicationDate(loan.getApplicationDate())</b>
<b class="fc">&nbsp;                .approvalDate(loan.getApprovalDate())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;
<b class="fc">&nbsp;        return Util.buildSuccessResponse(&quot;Loan status retrieved successfully&quot;, response, OK);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    public void processLoanScoring() {
<b class="fc">&nbsp;        int maxRetries = appConfig.getScoringRetryMaxAttempts();</b>
<b class="fc">&nbsp;        List&lt;Loan&gt; loansInProgress = loanRepository.findLoansForScoring(maxRetries);</b>
<b class="fc">&nbsp;        List&lt;String&gt; customerNumbers = loansInProgress.stream().map(Loan::getCustomerNumber).distinct().toList();</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Customer&gt; customers = customerRepository.findByCustomerNumberIn(customerNumbers);</b>
&nbsp;
<b class="fc">&nbsp;        log.info(&quot;Found {} loans to process for scoring...&quot;, loansInProgress.size());</b>
&nbsp;
<b class="fc">&nbsp;        for (Loan loan : loansInProgress) {</b>
<b class="fc">&nbsp;            customers.stream().</b>
<b class="fc">&nbsp;                    filter(c -&gt; Objects.equals(c.getCustomerNumber(), loan.getCustomerNumber())).</b>
<b class="fc">&nbsp;                    findFirst()</b>
<b class="fc">&nbsp;                    .ifPresent(customer -&gt; processIndividualLoanScoring(loan, customer));</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;    private void processIndividualLoanScoring(Loan loan, Customer customer) {
<b class="fc">&nbsp;        log.info(&quot;Processing scoring | loan ID: {}, token: {}&quot;, loan.getId(), customer.getScoringToken());</b>
&nbsp;
<b class="fc">&nbsp;        Optional&lt;ScoringResponse&gt; scoringResponseOpt = scoringService.getScore(customer.getScoringToken());</b>
&nbsp;
<b class="fc">&nbsp;        if (scoringResponseOpt.isPresent()) {</b>
<b class="fc">&nbsp;            updateLoanWithScoringResult(loan, scoringResponseOpt.get());</b>
<b class="fc">&nbsp;            log.info(&quot;Scoring completed | loan ID: {}, score: {}&quot;, loan.getId(), scoringResponseOpt.get().getScore());</b>
&nbsp;        } else {
<b class="fc">&nbsp;            loan.setRetryCount(loan.getRetryCount() + 1);</b>
<b class="pc">&nbsp;            if (loan.getRetryCount() &gt;= appConfig.getScoringRetryMaxAttempts()) {</b>
<b class="fc">&nbsp;                loan.setStatus(LoanStatus.FAILED);</b>
<b class="fc">&nbsp;                log.warn(&quot;Scoring failed | loan ID: {} after {} retries&quot;, loan.getId(), loan.getRetryCount());</b>
&nbsp;            }
<b class="fc">&nbsp;            log.info(&quot;Scoring not ready | loan ID: {}, retry count: {}&quot;, loan.getId(), loan.getRetryCount());</b>
<b class="fc">&nbsp;            loanRepository.save(loan);</b>
&nbsp;        }
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;    private Loan saveLoanRequest(LoanRequest request) {
<b class="fc">&nbsp;        Loan loan = new Loan();</b>
<b class="fc">&nbsp;        loan.setCustomerNumber(request.getCustomerNumber());</b>
<b class="fc">&nbsp;        loan.setRequestedAmount(request.getAmount());</b>
<b class="fc">&nbsp;        loan.setStatus(LoanStatus.PENDING);</b>
<b class="fc">&nbsp;        loan.setApplicationDate(LocalDateTime.now());</b>
<b class="fc">&nbsp;        loan.setRetryCount(0);</b>
<b class="fc">&nbsp;        return loanRepository.save(loan);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    private void updateLoanStatus(Loan loan) {
<b class="fc">&nbsp;        loan.setStatus(LoanStatus.SCORING_IN_PROGRESS);</b>
<b class="fc">&nbsp;        loanRepository.save(loan);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;    private void updateCustomerScoringToken(Customer customer, String scoringToken) {
<b class="fc">&nbsp;        customer.setScoringToken(scoringToken);</b>
<b class="fc">&nbsp;        customerRepository.save(customer);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;    private void updateLoanWithScoringResult(Loan loan, ScoringResponse scoringResponse) {
<b class="fc">&nbsp;        loan.setCreditScore(scoringResponse.getScore());</b>
<b class="fc">&nbsp;        loan.setCreditLimit(scoringResponse.getLimitAmount());</b>
<b class="fc">&nbsp;        loan.setExclusion(scoringResponse.getExclusion());</b>
<b class="fc">&nbsp;        loan.setExclusionReason(scoringResponse.getExclusionReason());</b>
&nbsp;
<b class="pc">&nbsp;        boolean approved = &quot;No Exclusion&quot;.equals(scoringResponse.getExclusion()) &amp;&amp; scoringResponse.getScore() &gt;= 500 &amp;&amp; loan.getRequestedAmount().compareTo(scoringResponse.getLimitAmount()) &lt;= 0;</b>
&nbsp;
<b class="pc">&nbsp;        if (approved) {</b>
<b class="fc">&nbsp;            loan.setStatus(LoanStatus.APPROVED);</b>
<b class="fc">&nbsp;            loan.setApprovedAmount(loan.getRequestedAmount());</b>
<b class="fc">&nbsp;            loan.setApprovalDate(LocalDateTime.now());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            loan.setStatus(LoanStatus.REJECTED);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        loanRepository.save(loan);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-06-01 10:12</div>
</div>
</body>
</html>
